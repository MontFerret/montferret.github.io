<!DOCTYPE html>
<html lang="en-us"><head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta http-equiv="X-UA-Compatible" content="ie=edge" />
    <title>Ferret</title>

    <meta name="generator" content="Hugo 0.111.3">

    <link
        href="https://fonts.googleapis.com/css?family=Source+Code+Pro:400,700"
        rel="stylesheet"
    />

    
    <link rel="stylesheet" href="https://www.montferret.dev/sass/main.min.abb9ad2a13db31eb59f44083603c76c8239bcbf3b2193f634e670e9b2f270b08.css" />
    <link rel="apple-touch-icon" sizes="57x57" href="/favicon/apple-icon-57x57.png" />
    <link rel="apple-touch-icon" sizes="60x60" href="/favicon/apple-icon-60x60.png" />
    <link rel="apple-touch-icon" sizes="72x72" href="/favicon/apple-icon-72x72.png" />
    <link rel="apple-touch-icon" sizes="76x76" href="/favicon/apple-icon-76x76.png" />
    <link
        rel="apple-touch-icon"
        sizes="114x114"
        href="/favicon/apple-icon-114x114.png"
    />
    <link
        rel="apple-touch-icon"
        sizes="120x120"
        href="/favicon/apple-icon-120x120.png"
    />
    <link
        rel="apple-touch-icon"
        sizes="144x144"
        href="/favicon/apple-icon-144x144.png"
    />
    <link
        rel="apple-touch-icon"
        sizes="152x152"
        href="/favicon/apple-icon-152x152.png"
    />
    <link
        rel="apple-touch-icon"
        sizes="180x180"
        href="/favicon/apple-icon-180x180.png"
    />
    <link
        rel="icon"
        type="image/png"
        sizes="192x192"
        href="/favicon/android-icon-192x192.png"
    />
    <link rel="icon" type="image/png" sizes="32x32" href="/favicon/favicon-32x32.png" />
    <link rel="icon" type="image/png" sizes="96x96" href="/favicon/favicon-96x96.png" />
    <link rel="icon" type="image/png" sizes="16x16" href="/favicon/favicon-16x16.png" />
    <link rel="manifest" href="/favicon/manifest.json" />
    
    <meta name="msapplication-TileColor" content="#ffffff" />
    <meta name="msapplication-TileImage" content="/favicon/ms-icon-144x144.png" />
    <meta name="theme-color" content="#ffffff" />
    
    <script async src="https://www.googletagmanager.com/gtag/js?id=UA-135792752-1"></script>
    <script>
        window.dataLayer = window.dataLayer || [];
        function gtag(){dataLayer.push(arguments);}
        gtag('js', new Date());
        gtag('config', 'UA-135792752-1');
    </script>
</head>
<body><nav class="navbar" role="navigation" aria-label="main navigation">
    <div class="container">
        <div class="navbar-brand">
            <a class="navbar-item" href="/">
                <img src="/img/logo.png" width="30" height="30" /> <small class="logo">ferret</small>
            </a>

            <a
                id="navbar-burger"
                role="button"
                class="navbar-burger burger"
                aria-label="menu"
                aria-expanded="false"
                data-target="primary-nav"
            >
                <span aria-hidden="true"></span>
                <span aria-hidden="true"></span>
                <span aria-hidden="true"></span>
            </a>
        </div>
        
        <div id="primary-nav" class="navbar-menu">
            <div class="navbar-start">
                
                
                
                        
                        <a href="/try/" class="navbar-item "
                        title=Try&#32;it id=repl>
                            Try it
                        </a>
                
                        
                        <a href="/docs/introduction" class="navbar-item "
                        title=Project&#32;documentation id=docs>
                            Docs
                        </a>
                
                        
                        <a href="/blog/" class="navbar-item "
                        title=Blog id=blog>
                            Blog
                        </a>
                
                        
                        <a href="/cookbook/google-search" class="navbar-item "
                        title=Cookbook id=cookbook>
                            Cookbook
                        </a>
                
            </div>

            <div class="navbar-end">
                
                
                        <a href="https://opencollective.com/ferret" class="navbar-item "
                        title=Open&#32;collective id=donate>
                            Donate
                        </a>
                
                        <a href="https://github.com/MontFerret/ferret" class="navbar-item "
                        title=GitHub&#32;repository id=github>
                            GitHub
                        </a>
                
            </div>
        </div>
    </div>
</nav>

<script>
    
    
    (function(){
        let navburger = document.getElementById("navbar-burger");
        navburger.addEventListener("click", function() {
            let target = this.getAttribute("data-target");
            let el = document.getElementById(target);

            el.classList.toggle("is-active");
        })
    })();
</script><div id="content">
    <div class="content section docs">
    <div class="columns">
        <section class="column is-2">
            <aside class="menu">
    
    











<p class="menu-label">
    General
</p>


<ul class="menu-list">
    
        
        
        

        
            
            <li>
                <a href="https://www.montferret.dev/docs/introduction/" class="">
                    Introduction
                </a>  
            </li>

            
        
    
        
        
        

        
            
            <li>
                <a href="https://www.montferret.dev/docs/installation/" class="">
                    Installation
                </a>  
            </li>

            
        
    
        
        
        

        
            
            <li>
                <a href="https://www.montferret.dev/docs/getting-started/" class="">
                    Getting started
                </a>  
            </li>

            
        
    
        
        
        

        
    
        
        
        

        
    


</ul>



    
    
        

        
            











<p class="menu-label">
    Query language
</p>


<ul class="menu-list">
    
        
        
        

        
            
            <li>
                <a href="https://www.montferret.dev/docs/fql/introduction/" class="">
                    Introduction
                </a>  
            </li>

            
        
    
        
        
        

        
            
            <li>
                <a href="https://www.montferret.dev/docs/fql/syntax/" class="">
                    Syntax
                </a>  
            </li>

            
        
    
        
        
        

        
            
            <li>
                <a href="https://www.montferret.dev/docs/fql/data-types/" class="">
                    Data types
                </a>  
            </li>

            
        
    
        
        
        

        
            
            <li>
                <a href="https://www.montferret.dev/docs/fql/operators/" class="">
                    Operators
                </a>  
            </li>

            
                
                    












<ul class="menu-list">
    
        
        
        

        
            
            <li>
                <a href="https://www.montferret.dev/docs/fql/operators/high-level/for/" class="">
                    FOR
                </a>  
            </li>

            
        
    
        
        
        

        
            
            <li>
                <a href="https://www.montferret.dev/docs/fql/operators/high-level/return/" class="">
                    RETURN
                </a>  
            </li>

            
        
    
        
        
        

        
            
            <li>
                <a href="https://www.montferret.dev/docs/fql/operators/high-level/filter/" class="">
                    FILTER
                </a>  
            </li>

            
        
    
        
        
        

        
            
            <li>
                <a href="https://www.montferret.dev/docs/fql/operators/high-level/sort/" class="">
                    SORT
                </a>  
            </li>

            
        
    
        
        
        

        
            
            <li>
                <a href="https://www.montferret.dev/docs/fql/operators/high-level/limit/" class="">
                    LIMIT
                </a>  
            </li>

            
        
    
        
        
        

        
            
            <li>
                <a href="https://www.montferret.dev/docs/fql/operators/high-level/let/" class="">
                    LET
                </a>  
            </li>

            
        
    
        
        
        

        
            
            <li>
                <a href="https://www.montferret.dev/docs/fql/operators/high-level/collect/" class="is-active">
                    COLLECT
                </a>  
            </li>

            
        
    






</ul>

                
            
        
    
        
        
        

        
            
            <li>
                <a href="https://www.montferret.dev/docs/fql/bind-parameters/" class="">
                    Bind parameters
                </a>  
            </li>

            
        
    
        
        
        

        
            
            <li>
                <a href="https://www.montferret.dev/docs/fql/type-value-order/" class="">
                    Type and value order
                </a>  
            </li>

            
        
    
        
        
        

        
            
            <li>
                <a href="https://www.montferret.dev/docs/fql/query-results/" class="">
                    Query results
                </a>  
            </li>

            
        
    
        
        
        

        
            
            <li>
                <a href="https://www.montferret.dev/docs/fql/query-errors/" class="">
                    Query errors
                </a>  
            </li>

            
        
    




    
    



</ul>

        
    

    
    
        

        
            











<p class="menu-label">
    stdlib
</p>


<ul class="menu-list">
    
        
        
        

        
            
            <li>
                <a href="https://www.montferret.dev/docs/stdlib/arrays/" class="">
                    arrays
                </a>  
            </li>

            
        
    
        
        
        

        
            
            <li>
                <a href="https://www.montferret.dev/docs/stdlib/collections/" class="">
                    collections
                </a>  
            </li>

            
        
    
        
        
        

        
            
            <li>
                <a href="https://www.montferret.dev/docs/stdlib/datetime/" class="">
                    datetime
                </a>  
            </li>

            
        
    
        
        
        

        
            
            <li>
                <a href="https://www.montferret.dev/docs/stdlib/html/" class="">
                    html
                </a>  
            </li>

            
        
    
        
        
        

        
            
            <li>
                <a href="https://www.montferret.dev/docs/stdlib/io-fs/" class="">
                    io/fs
                </a>  
            </li>

            
        
    
        
        
        

        
            
            <li>
                <a href="https://www.montferret.dev/docs/stdlib/io-net-http/" class="">
                    io/net/http
                </a>  
            </li>

            
        
    
        
        
        

        
            
            <li>
                <a href="https://www.montferret.dev/docs/stdlib/math/" class="">
                    math
                </a>  
            </li>

            
        
    
        
        
        

        
            
            <li>
                <a href="https://www.montferret.dev/docs/stdlib/objects/" class="">
                    objects
                </a>  
            </li>

            
        
    
        
        
        

        
            
            <li>
                <a href="https://www.montferret.dev/docs/stdlib/path/" class="">
                    path
                </a>  
            </li>

            
        
    
        
        
        

        
            
            <li>
                <a href="https://www.montferret.dev/docs/stdlib/strings/" class="">
                    strings
                </a>  
            </li>

            
        
    
        
        
        

        
            
            <li>
                <a href="https://www.montferret.dev/docs/stdlib/testing/" class="">
                    testing
                </a>  
            </li>

            
        
    
        
        
        

        
            
            <li>
                <a href="https://www.montferret.dev/docs/stdlib/types/" class="">
                    types
                </a>  
            </li>

            
        
    
        
        
        

        
            
            <li>
                <a href="https://www.montferret.dev/docs/stdlib/utils/" class="">
                    utils
                </a>  
            </li>

            
        
    






</ul>

        
    



</aside>

        </section>

        <section id="main" class="column is-8">
            <article id="content" class="has-text-justified">
    <ul>
<li></li>
</ul>



<h1 id="collect">
<a href="#collect">
COLLECT
</a>
</h1>
<p>The <code>COLLECT</code> keyword can be used to group an array by one or multiple group criteria.</p>
<p>The <code>COLLECT</code> statement will eliminate all local variables in the current scope. After <code>COLLECT</code> only the variables introduced by <code>COLLECT</code> itself are available.</p>
<p>There are several syntax variants for <code>COLLECT</code> operations:</p>




<div class="code-editor">
    <div class="columns">
        <div class="column is-full">
            <div id="code-54-text" class="code-editor-text" style="height: 230px;">
                
COLLECT variableName = expression
COLLECT variableName = expression INTO groupsVariable
COLLECT variableName = expression INTO groupsVariable = projectionExpression
COLLECT variableName = expression INTO groupsVariable KEEP keepVariable
COLLECT variableName = expression WITH COUNT INTO countVariable
COLLECT variableName = expression AGGREGATE variableName = aggregateExpression
COLLECT variableName = expression AGGREGATE variableName = aggregateExpression INTO groupsVariable
COLLECT AGGREGATE variableName = aggregateExpression
COLLECT AGGREGATE variableName = aggregateExpression INTO groupsVariable
COLLECT WITH COUNT INTO countVariable

            </div>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function () {
            const editor = ace.edit('code-54-text');
            editor.setTheme("ace/theme/tomorrow_night");
            editor.session.setMode("ace/mode/" + 'aql');
            editor.setOptions({
                readOnly: true,
                highlightActiveLine: false,
                highlightGutterLine: false,
                displayIndentGuides: false,
                printMargin: false
            });
            editor.renderer.$cursorLayer.element.style.display = "none"
        }, false);
    </script>
</div>



<h3 id="collect-grouping">
<a href="#collect-grouping">
Grouping syntaxes
</a>
</h3>
<p>The first syntax form of <code>COLLECT</code> only groups the result by the defined group criteria specified in expression. In order to further process the results produced by <code>COLLECT</code>, a new variable (specified by <code>variableName</code>) is introduced. This variable contains the group value.</p>
<p>Here’s an example query that find the distinct values in u.city and makes them available in variable city:</p>








<div class="code-editor">

    
    <button id="code-editor-696-run-button" class="run button is-pulled-right is-outlined is-light is-radiusless code-editor-button">Run</button>

    <div class="columns">
        <div class="column is-12">
            <div id="code-editor-696-text" class="code-editor-text" style="height: 200px;">
                
LET users = [{"id":1,"name":"Thorn De Banke","city":"New York City"},{"id":2,"name":"Adolph MacAindreis","city":"Moscow"},{"id":3,"name":"Flory Maxworthy","city":"London"},{"id":4,"name":"Merola Blundell","city":"New York City"},{"id":5,"name":"Benson Manoelli","city":"Moscow"},{"id":6,"name":"Cordy McVie","city":"London"},{"id":7,"name":"Reggy Tuck","city":"New York City"},{"id":8,"name":"Courtney Toogood","city":"Berlin"},{"id":9,"name":"Berkley Fields","city":"Berlin"},{"id":10,"name":"Findley Gauvain","city":"Stockholm"}]

FOR u IN users
  COLLECT city = u.city
  
  RETURN { 
    "city" : city 
  }

            </div>
        </div>
    </div>
    <div class="columns">
        <div class="column is-12">
            <div id="code-editor-696-result" class="code-editor-result" style="height: 200px;"></div>
        </div>
    </div>
    

    <script>
        document.addEventListener('DOMContentLoaded', function () {
            function createEditor(id, mode) {
                const editor = ace.edit(id);
                editor.setTheme("ace\/theme\/tomorrow_night");
                editor.session.setMode("ace/mode/" + mode);
                editor.setOptions({
                    displayIndentGuides: false,
                    printMargin: false
                });

                return editor;
            }

            const btn = document.querySelector('#code-editor-696-run-button');
            const textEditor = createEditor('code-editor-696-text', 'aql');
            const resultEditor = createEditor('code-editor-696-result', 'json');
            resultEditor.setReadOnly(true);

            function setContent(editor, content) {
                editor.setValue(content, -1);
            }

            let isRunning = false;

            function onStart() {
                isRunning = true;
                textEditor.setReadOnly(true);
                btn.classList.add('is-loading');
            }

            function onEnd(result) {
                isRunning = false;
                textEditor.setReadOnly(false);
                btn.classList.remove('is-loading');

                setContent(resultEditor, result);
            }

            btn.addEventListener('click', () => {
                if (isRunning) {
                    return;
                }

                const body = {
                        text: textEditor.getValue(),
                        params: JSON.parse("{}")
                };

                onStart();
                fetch("https:\/\/worker-pucbyp2omq-ue.a.run.app", {
                    method: 'post',
                    cache: 'no-cache',
                    headers: {
                        'Content-Type': 'application/json,encoding=utf-8'
                    },
                    body: JSON.stringify(body)
                })
                    .then(r => {
                        if (r.status === 200) {
                            return r.json()
                        }
                        
                        if (r.status === 426) {
                            throw new Error(`Too many requests. Try again later.`);
                        }
                        
                        if (r.status === 400) {
                            return r.json().then((data) => {
                                throw new Error(data.error);
                            });
                        }
                        
                        throw new Error(`Unexpected error. Try again later.`);
                    })
                    .then((data) => {
                        onEnd(JSON.stringify(data, null, 4));
                    })
                    .catch((err) => {
                        onEnd(err.message);
                    });
            });
        }, false);
    </script>
</div>
<p>The second form does the same as the first form, but additionally introduces a variable (specified by <code>groupsVariable</code>) that contains all elements that fell into the group. This works as follows: The <code>groupsVariable</code> variable is an array containing as many elements as there are in the group. Each member of that array is a JSON object in which the value of every variable that is defined in the FQL query is bound to the corresponding property. Note that this considers all variables that are defined before the <code>COLLECT</code> statement, but not those on the top level (outside of any FOR), unless the <code>COLLECT</code> statement is itself on the top level, in which case all variables are taken.</p>








<div class="code-editor">

    
    <button id="code-editor-315-run-button" class="run button is-pulled-right is-outlined is-light is-radiusless code-editor-button">Run</button>

    <div class="columns">
        <div class="column is-12">
            <div id="code-editor-315-text" class="code-editor-text" style="height: 200px;">
                
LET users = [{"id":1,"name":"Thorn De Banke","city":"New York City"},{"id":2,"name":"Adolph MacAindreis","city":"Moscow"},{"id":3,"name":"Flory Maxworthy","city":"London"},{"id":4,"name":"Merola Blundell","city":"New York City"},{"id":5,"name":"Benson Manoelli","city":"Moscow"},{"id":6,"name":"Cordy McVie","city":"London"},{"id":7,"name":"Reggy Tuck","city":"New York City"},{"id":8,"name":"Courtney Toogood","city":"Berlin"},{"id":9,"name":"Berkley Fields","city":"Berlin"},{"id":10,"name":"Findley Gauvain","city":"Stockholm"}]

FOR u IN users
  COLLECT city = u.city INTO groups
  
  RETURN { 
    "city" : city, 
    "usersInCity" : groups 
  }

            </div>
        </div>
    </div>
    <div class="columns">
        <div class="column is-12">
            <div id="code-editor-315-result" class="code-editor-result" style="height: 200px;"></div>
        </div>
    </div>
    

    <script>
        document.addEventListener('DOMContentLoaded', function () {
            function createEditor(id, mode) {
                const editor = ace.edit(id);
                editor.setTheme("ace\/theme\/tomorrow_night");
                editor.session.setMode("ace/mode/" + mode);
                editor.setOptions({
                    displayIndentGuides: false,
                    printMargin: false
                });

                return editor;
            }

            const btn = document.querySelector('#code-editor-315-run-button');
            const textEditor = createEditor('code-editor-315-text', 'aql');
            const resultEditor = createEditor('code-editor-315-result', 'json');
            resultEditor.setReadOnly(true);

            function setContent(editor, content) {
                editor.setValue(content, -1);
            }

            let isRunning = false;

            function onStart() {
                isRunning = true;
                textEditor.setReadOnly(true);
                btn.classList.add('is-loading');
            }

            function onEnd(result) {
                isRunning = false;
                textEditor.setReadOnly(false);
                btn.classList.remove('is-loading');

                setContent(resultEditor, result);
            }

            btn.addEventListener('click', () => {
                if (isRunning) {
                    return;
                }

                const body = {
                        text: textEditor.getValue(),
                        params: JSON.parse("{}")
                };

                onStart();
                fetch("https:\/\/worker-pucbyp2omq-ue.a.run.app", {
                    method: 'post',
                    cache: 'no-cache',
                    headers: {
                        'Content-Type': 'application/json,encoding=utf-8'
                    },
                    body: JSON.stringify(body)
                })
                    .then(r => {
                        if (r.status === 200) {
                            return r.json()
                        }
                        
                        if (r.status === 426) {
                            throw new Error(`Too many requests. Try again later.`);
                        }
                        
                        if (r.status === 400) {
                            return r.json().then((data) => {
                                throw new Error(data.error);
                            });
                        }
                        
                        throw new Error(`Unexpected error. Try again later.`);
                    })
                    .then((data) => {
                        onEnd(JSON.stringify(data, null, 4));
                    })
                    .catch((err) => {
                        onEnd(err.message);
                    });
            });
        }, false);
    </script>
</div>
<p>In the above example, the array users will be grouped by the property city. The result is a new array of objects, with one object per distinct <code>u.city</code> value. The elements from the original array (here: <code>users</code>) per city are made available in the variable groups. This is due to the <code>INTO</code> clause.</p>
<p><code>COLLECT</code> also allows specifying multiple group criteria. Individual group criteria can be separated by commas:</p>








<div class="code-editor">

    
    <button id="code-editor-954-run-button" class="run button is-pulled-right is-outlined is-light is-radiusless code-editor-button">Run</button>

    <div class="columns">
        <div class="column is-12">
            <div id="code-editor-954-text" class="code-editor-text" style="height: 200px;">
                
LET users = [{"id":1,"name":"Thorn De Banke","city":"New York City","country":"USA"},{"id":2,"name":"Adolph MacAindreis","city":"Moscow","country":"Russia"},{"id":3,"name":"Flory Maxworthy","city":"London","country":"UK"},{"id":4,"name":"Merola Blundell","city":"New York City","country":"USA"},{"id":5,"name":"Benson Manoelli","city":"Moscow","country":"Russia"},{"id":6,"name":"Cordy McVie","city":"London","country":"UK"},{"id":7,"name":"Reggy Tuck","city":"New York City","country":"USA"},{"id":8,"name":"Courtney Toogood","city":"Berlin","country":"Germany"},{"id":9,"name":"Berkley Fields","city":"Berlin","country":"Germany"},{"id":10,"name":"Findley Gauvain","city":"Stockholm","country":"Sweden"}]

FOR u IN users
  COLLECT country = u.country, city = u.city INTO groups
  
  RETURN { 
    "country" : country, 
    "city" : city, 
    "usersInCity" : groups 
  }

            </div>
        </div>
    </div>
    <div class="columns">
        <div class="column is-12">
            <div id="code-editor-954-result" class="code-editor-result" style="height: 200px;"></div>
        </div>
    </div>
    

    <script>
        document.addEventListener('DOMContentLoaded', function () {
            function createEditor(id, mode) {
                const editor = ace.edit(id);
                editor.setTheme("ace\/theme\/tomorrow_night");
                editor.session.setMode("ace/mode/" + mode);
                editor.setOptions({
                    displayIndentGuides: false,
                    printMargin: false
                });

                return editor;
            }

            const btn = document.querySelector('#code-editor-954-run-button');
            const textEditor = createEditor('code-editor-954-text', 'aql');
            const resultEditor = createEditor('code-editor-954-result', 'json');
            resultEditor.setReadOnly(true);

            function setContent(editor, content) {
                editor.setValue(content, -1);
            }

            let isRunning = false;

            function onStart() {
                isRunning = true;
                textEditor.setReadOnly(true);
                btn.classList.add('is-loading');
            }

            function onEnd(result) {
                isRunning = false;
                textEditor.setReadOnly(false);
                btn.classList.remove('is-loading');

                setContent(resultEditor, result);
            }

            btn.addEventListener('click', () => {
                if (isRunning) {
                    return;
                }

                const body = {
                        text: textEditor.getValue(),
                        params: JSON.parse("{}")
                };

                onStart();
                fetch("https:\/\/worker-pucbyp2omq-ue.a.run.app", {
                    method: 'post',
                    cache: 'no-cache',
                    headers: {
                        'Content-Type': 'application/json,encoding=utf-8'
                    },
                    body: JSON.stringify(body)
                })
                    .then(r => {
                        if (r.status === 200) {
                            return r.json()
                        }
                        
                        if (r.status === 426) {
                            throw new Error(`Too many requests. Try again later.`);
                        }
                        
                        if (r.status === 400) {
                            return r.json().then((data) => {
                                throw new Error(data.error);
                            });
                        }
                        
                        throw new Error(`Unexpected error. Try again later.`);
                    })
                    .then((data) => {
                        onEnd(JSON.stringify(data, null, 4));
                    })
                    .catch((err) => {
                        onEnd(err.message);
                    });
            });
        }, false);
    </script>
</div>
<p>In the above example, the array users is grouped by country first and then by city, and for each distinct combination of country and city, the users will be returned.</p>



<h3 id="collect-obsolete-variables">
<a href="#collect-obsolete-variables">
Discarding obsolete variables
</a>
</h3>
<p>The third form of <code>COLLECT</code> allows rewriting the contents of the <code>groupsVariable</code> using an arbitrary <code>projectionExpression</code>:</p>








<div class="code-editor">

    
    <button id="code-editor-745-run-button" class="run button is-pulled-right is-outlined is-light is-radiusless code-editor-button">Run</button>

    <div class="columns">
        <div class="column is-12">
            <div id="code-editor-745-text" class="code-editor-text" style="height: 200px;">
                
LET users = [{"id":1,"name":"Thorn De Banke","city":"New York City","country":"USA"},{"id":2,"name":"Adolph MacAindreis","city":"Moscow","country":"Russia"},{"id":3,"name":"Flory Maxworthy","city":"London","country":"UK"},{"id":4,"name":"Merola Blundell","city":"New York City","country":"USA"},{"id":5,"name":"Benson Manoelli","city":"Moscow","country":"Russia"},{"id":6,"name":"Cordy McVie","city":"London","country":"UK"},{"id":7,"name":"Reggy Tuck","city":"New York City","country":"USA"},{"id":8,"name":"Courtney Toogood","city":"Berlin","country":"Germany"},{"id":9,"name":"Berkley Fields","city":"Berlin","country":"Germany"},{"id":10,"name":"Findley Gauvain","city":"Stockholm","country":"Sweden"}]

FOR u IN users
  COLLECT country = u.country, city = u.city INTO groups = u.name
  
  RETURN { 
    "country" : country, 
    "city" : city, 
    "userNames" : groups 
  }

            </div>
        </div>
    </div>
    <div class="columns">
        <div class="column is-12">
            <div id="code-editor-745-result" class="code-editor-result" style="height: 200px;"></div>
        </div>
    </div>
    

    <script>
        document.addEventListener('DOMContentLoaded', function () {
            function createEditor(id, mode) {
                const editor = ace.edit(id);
                editor.setTheme("ace\/theme\/tomorrow_night");
                editor.session.setMode("ace/mode/" + mode);
                editor.setOptions({
                    displayIndentGuides: false,
                    printMargin: false
                });

                return editor;
            }

            const btn = document.querySelector('#code-editor-745-run-button');
            const textEditor = createEditor('code-editor-745-text', 'aql');
            const resultEditor = createEditor('code-editor-745-result', 'json');
            resultEditor.setReadOnly(true);

            function setContent(editor, content) {
                editor.setValue(content, -1);
            }

            let isRunning = false;

            function onStart() {
                isRunning = true;
                textEditor.setReadOnly(true);
                btn.classList.add('is-loading');
            }

            function onEnd(result) {
                isRunning = false;
                textEditor.setReadOnly(false);
                btn.classList.remove('is-loading');

                setContent(resultEditor, result);
            }

            btn.addEventListener('click', () => {
                if (isRunning) {
                    return;
                }

                const body = {
                        text: textEditor.getValue(),
                        params: JSON.parse("{}")
                };

                onStart();
                fetch("https:\/\/worker-pucbyp2omq-ue.a.run.app", {
                    method: 'post',
                    cache: 'no-cache',
                    headers: {
                        'Content-Type': 'application/json,encoding=utf-8'
                    },
                    body: JSON.stringify(body)
                })
                    .then(r => {
                        if (r.status === 200) {
                            return r.json()
                        }
                        
                        if (r.status === 426) {
                            throw new Error(`Too many requests. Try again later.`);
                        }
                        
                        if (r.status === 400) {
                            return r.json().then((data) => {
                                throw new Error(data.error);
                            });
                        }
                        
                        throw new Error(`Unexpected error. Try again later.`);
                    })
                    .then((data) => {
                        onEnd(JSON.stringify(data, null, 4));
                    })
                    .catch((err) => {
                        onEnd(err.message);
                    });
            });
        }, false);
    </script>
</div>
<p>In the above example, only the <code>projectionExpression</code> is <code>u.name</code>. Therefore, only this property is copied into the <code>groupsVariable</code> for each object. This is probably much more efficient than copying all variables from the scope into the <code>groupsVariable</code> as it would happen without a <code>projectionExpression</code>.</p>
<p>The expression following <code>INTO</code> can also be used for arbitrary computations:</p>








<div class="code-editor">

    
    <button id="code-editor-170-run-button" class="run button is-pulled-right is-outlined is-light is-radiusless code-editor-button">Run</button>

    <div class="columns">
        <div class="column is-12">
            <div id="code-editor-170-text" class="code-editor-text" style="height: 250px;">
                
LET users = [{"id":1,"name":"Thorn De Banke","city":"New York City","country":"USA","status":"active"},{"id":2,"name":"Adolph MacAindreis","city":"Moscow","country":"Russia","status":"active"},{"id":3,"name":"Flory Maxworthy","city":"London","country":"UK","status":"active"},{"id":4,"name":"Merola Blundell","city":"New York City","country":"USA","status":"inactive"},{"id":5,"name":"Benson Manoelli","city":"Moscow","country":"Russia","status":"inactive"},{"id":6,"name":"Cordy McVie","city":"London","country":"UK","status":"active"},{"id":7,"name":"Reggy Tuck","city":"New York City","country":"USA","status":"active"},{"id":8,"name":"Courtney Toogood","city":"Berlin","country":"Germany","status":"active"},{"id":9,"name":"Berkley Fields","city":"Berlin","country":"Germany","status":"inactive"},{"id":10,"name":"Findley Gauvain","city":"Stockholm","country":"Sweden","status":"inactive"}]

FOR u IN users
  COLLECT country = u.country, city = u.city INTO groups = { 
    "name" : u.name, 
    "isActive" : u.status == "active"
  }
  RETURN { 
    "country" : country, 
    "city" : city, 
    "usersInCity" : groups 
  }

            </div>
        </div>
    </div>
    <div class="columns">
        <div class="column is-12">
            <div id="code-editor-170-result" class="code-editor-result" style="height: 250px;"></div>
        </div>
    </div>
    

    <script>
        document.addEventListener('DOMContentLoaded', function () {
            function createEditor(id, mode) {
                const editor = ace.edit(id);
                editor.setTheme("ace\/theme\/tomorrow_night");
                editor.session.setMode("ace/mode/" + mode);
                editor.setOptions({
                    displayIndentGuides: false,
                    printMargin: false
                });

                return editor;
            }

            const btn = document.querySelector('#code-editor-170-run-button');
            const textEditor = createEditor('code-editor-170-text', 'aql');
            const resultEditor = createEditor('code-editor-170-result', 'json');
            resultEditor.setReadOnly(true);

            function setContent(editor, content) {
                editor.setValue(content, -1);
            }

            let isRunning = false;

            function onStart() {
                isRunning = true;
                textEditor.setReadOnly(true);
                btn.classList.add('is-loading');
            }

            function onEnd(result) {
                isRunning = false;
                textEditor.setReadOnly(false);
                btn.classList.remove('is-loading');

                setContent(resultEditor, result);
            }

            btn.addEventListener('click', () => {
                if (isRunning) {
                    return;
                }

                const body = {
                        text: textEditor.getValue(),
                        params: JSON.parse("{}")
                };

                onStart();
                fetch("https:\/\/worker-pucbyp2omq-ue.a.run.app", {
                    method: 'post',
                    cache: 'no-cache',
                    headers: {
                        'Content-Type': 'application/json,encoding=utf-8'
                    },
                    body: JSON.stringify(body)
                })
                    .then(r => {
                        if (r.status === 200) {
                            return r.json()
                        }
                        
                        if (r.status === 426) {
                            throw new Error(`Too many requests. Try again later.`);
                        }
                        
                        if (r.status === 400) {
                            return r.json().then((data) => {
                                throw new Error(data.error);
                            });
                        }
                        
                        throw new Error(`Unexpected error. Try again later.`);
                    })
                    .then((data) => {
                        onEnd(JSON.stringify(data, null, 4));
                    })
                    .catch((err) => {
                        onEnd(err.message);
                    });
            });
        }, false);
    </script>
</div>
<!-- ``COLLECT`` also provides an optional ``KEEP`` clause that can be used to control which variables will be copied into the variable created by ``INTO``. If no ``KEEP`` clause is specified, all variables from the scope will be copied as sub-attributes into the ``groupsVariable``. This is safe but can have a negative impact on performance if there are many variables in scope or the variables contain massive amounts of data.

The following example limits the variables that are copied into the ``groupsVariable`` to just name. The variables ``u`` and ``someCalculation`` also present in the scope will not be copied into ``groupsVariable`` because they are not listed in the ``KEEP`` clause:









<div class="code-editor">

    
    <button id="code-editor-530-run-button" class="run button is-pulled-right is-outlined is-light is-radiusless code-editor-button">Run</button>

    <div class="columns">
        <div class="column is-12">
            <div id="code-editor-530-text" class="code-editor-text" style="height: 250px;">
                
LET users = [{"id":1,"name":"Thorn De Banke","city":"New York City","country":"USA","status":"active"},{"id":2,"name":"Adolph MacAindreis","city":"Moscow","country":"Russia","status":"active"},{"id":3,"name":"Flory Maxworthy","city":"London","country":"UK","status":"active"},{"id":4,"name":"Merola Blundell","city":"New York City","country":"USA","status":"inactive"},{"id":5,"name":"Benson Manoelli","city":"Moscow","country":"Russia","status":"inactive"},{"id":6,"name":"Cordy McVie","city":"London","country":"UK","status":"active"},{"id":7,"name":"Reggy Tuck","city":"New York City","country":"USA","status":"active"},{"id":8,"name":"Courtney Toogood","city":"Berlin","country":"Germany","status":"active"},{"id":9,"name":"Berkley Fields","city":"Berlin","country":"Germany","status":"inactive"},{"id":10,"name":"Findley Gauvain","city":"Stockholm","country":"Sweden","status":"inactive"}]

FOR u IN users
  LET name = u.name
  LET someCalculation = u.value1 + u.value2
  COLLECT city = u.city INTO groups KEEP name 
  
  RETURN { 
    "city" : city, 
    "userNames" : groups[*].name 
  }

            </div>
        </div>
    </div>
    <div class="columns">
        <div class="column is-12">
            <div id="code-editor-530-result" class="code-editor-result" style="height: 250px;"></div>
        </div>
    </div>
    

    <script>
        document.addEventListener('DOMContentLoaded', function () {
            function createEditor(id, mode) {
                const editor = ace.edit(id);
                editor.setTheme("ace\/theme\/tomorrow_night");
                editor.session.setMode("ace/mode/" + mode);
                editor.setOptions({
                    displayIndentGuides: false,
                    printMargin: false
                });

                return editor;
            }

            const btn = document.querySelector('#code-editor-530-run-button');
            const textEditor = createEditor('code-editor-530-text', 'aql');
            const resultEditor = createEditor('code-editor-530-result', 'json');
            resultEditor.setReadOnly(true);

            function setContent(editor, content) {
                editor.setValue(content, -1);
            }

            let isRunning = false;

            function onStart() {
                isRunning = true;
                textEditor.setReadOnly(true);
                btn.classList.add('is-loading');
            }

            function onEnd(result) {
                isRunning = false;
                textEditor.setReadOnly(false);
                btn.classList.remove('is-loading');

                setContent(resultEditor, result);
            }

            btn.addEventListener('click', () => {
                if (isRunning) {
                    return;
                }

                const body = {
                        text: textEditor.getValue(),
                        params: JSON.parse("{}")
                };

                onStart();
                fetch("https:\/\/worker-pucbyp2omq-ue.a.run.app", {
                    method: 'post',
                    cache: 'no-cache',
                    headers: {
                        'Content-Type': 'application/json,encoding=utf-8'
                    },
                    body: JSON.stringify(body)
                })
                    .then(r => {
                        if (r.status === 200) {
                            return r.json()
                        }
                        
                        if (r.status === 426) {
                            throw new Error(`Too many requests. Try again later.`);
                        }
                        
                        if (r.status === 400) {
                            return r.json().then((data) => {
                                throw new Error(data.error);
                            });
                        }
                        
                        throw new Error(`Unexpected error. Try again later.`);
                    })
                    .then((data) => {
                        onEnd(JSON.stringify(data, null, 4));
                    })
                    .catch((err) => {
                        onEnd(err.message);
                    });
            });
        }, false);
    </script>
</div> -->



<h3 id="collect-group-length">
<a href="#collect-group-length">
Group length calculation
</a>
</h3>
<p><code>COLLECT</code> also provides a special <code>WITH COUNT</code> clause that can be used to determine the number of group members efficiently.</p>
<p>The simplest form just returns the number of items that made it into the <code>COLLECT</code>:</p>








<div class="code-editor">

    
    <button id="code-editor-726-run-button" class="run button is-pulled-right is-outlined is-light is-radiusless code-editor-button">Run</button>

    <div class="columns">
        <div class="column is-12">
            <div id="code-editor-726-text" class="code-editor-text" style="height: 180px;">
                
LET users = [{"id":1,"name":"Thorn De Banke","city":"New York City","country":"USA","status":"active"},{"id":2,"name":"Adolph MacAindreis","city":"Moscow","country":"Russia","status":"active"},{"id":3,"name":"Flory Maxworthy","city":"London","country":"UK","status":"active"},{"id":4,"name":"Merola Blundell","city":"New York City","country":"USA","status":"inactive"},{"id":5,"name":"Benson Manoelli","city":"Moscow","country":"Russia","status":"inactive"},{"id":6,"name":"Cordy McVie","city":"London","country":"UK","status":"active"},{"id":7,"name":"Reggy Tuck","city":"New York City","country":"USA","status":"active"},{"id":8,"name":"Courtney Toogood","city":"Berlin","country":"Germany","status":"active"},{"id":9,"name":"Berkley Fields","city":"Berlin","country":"Germany","status":"inactive"},{"id":10,"name":"Findley Gauvain","city":"Stockholm","country":"Sweden","status":"inactive"}]

FOR u IN users
  COLLECT WITH COUNT INTO length
  
  RETURN length

            </div>
        </div>
    </div>
    <div class="columns">
        <div class="column is-12">
            <div id="code-editor-726-result" class="code-editor-result" style="height: 180px;"></div>
        </div>
    </div>
    

    <script>
        document.addEventListener('DOMContentLoaded', function () {
            function createEditor(id, mode) {
                const editor = ace.edit(id);
                editor.setTheme("ace\/theme\/tomorrow_night");
                editor.session.setMode("ace/mode/" + mode);
                editor.setOptions({
                    displayIndentGuides: false,
                    printMargin: false
                });

                return editor;
            }

            const btn = document.querySelector('#code-editor-726-run-button');
            const textEditor = createEditor('code-editor-726-text', 'aql');
            const resultEditor = createEditor('code-editor-726-result', 'json');
            resultEditor.setReadOnly(true);

            function setContent(editor, content) {
                editor.setValue(content, -1);
            }

            let isRunning = false;

            function onStart() {
                isRunning = true;
                textEditor.setReadOnly(true);
                btn.classList.add('is-loading');
            }

            function onEnd(result) {
                isRunning = false;
                textEditor.setReadOnly(false);
                btn.classList.remove('is-loading');

                setContent(resultEditor, result);
            }

            btn.addEventListener('click', () => {
                if (isRunning) {
                    return;
                }

                const body = {
                        text: textEditor.getValue(),
                        params: JSON.parse("{}")
                };

                onStart();
                fetch("https:\/\/worker-pucbyp2omq-ue.a.run.app", {
                    method: 'post',
                    cache: 'no-cache',
                    headers: {
                        'Content-Type': 'application/json,encoding=utf-8'
                    },
                    body: JSON.stringify(body)
                })
                    .then(r => {
                        if (r.status === 200) {
                            return r.json()
                        }
                        
                        if (r.status === 426) {
                            throw new Error(`Too many requests. Try again later.`);
                        }
                        
                        if (r.status === 400) {
                            return r.json().then((data) => {
                                throw new Error(data.error);
                            });
                        }
                        
                        throw new Error(`Unexpected error. Try again later.`);
                    })
                    .then((data) => {
                        onEnd(JSON.stringify(data, null, 4));
                    })
                    .catch((err) => {
                        onEnd(err.message);
                    });
            });
        }, false);
    </script>
</div>
<p>The above is equivalent to, but less efficient than:</p>








<div class="code-editor">

    
    <button id="code-editor-848-run-button" class="run button is-pulled-right is-outlined is-light is-radiusless code-editor-button">Run</button>

    <div class="columns">
        <div class="column is-12">
            <div id="code-editor-848-text" class="code-editor-text" style="height: 130px;">
                
LET users = [{"id":1,"name":"Thorn De Banke","city":"New York City","country":"USA","status":"active"},{"id":2,"name":"Adolph MacAindreis","city":"Moscow","country":"Russia","status":"active"},{"id":3,"name":"Flory Maxworthy","city":"London","country":"UK","status":"active"},{"id":4,"name":"Merola Blundell","city":"New York City","country":"USA","status":"inactive"},{"id":5,"name":"Benson Manoelli","city":"Moscow","country":"Russia","status":"inactive"},{"id":6,"name":"Cordy McVie","city":"London","country":"UK","status":"active"},{"id":7,"name":"Reggy Tuck","city":"New York City","country":"USA","status":"active"},{"id":8,"name":"Courtney Toogood","city":"Berlin","country":"Germany","status":"active"},{"id":9,"name":"Berkley Fields","city":"Berlin","country":"Germany","status":"inactive"},{"id":10,"name":"Findley Gauvain","city":"Stockholm","country":"Sweden","status":"inactive"}]

RETURN LENGTH(users)

            </div>
        </div>
    </div>
    <div class="columns">
        <div class="column is-12">
            <div id="code-editor-848-result" class="code-editor-result" style="height: 130px;"></div>
        </div>
    </div>
    

    <script>
        document.addEventListener('DOMContentLoaded', function () {
            function createEditor(id, mode) {
                const editor = ace.edit(id);
                editor.setTheme("ace\/theme\/tomorrow_night");
                editor.session.setMode("ace/mode/" + mode);
                editor.setOptions({
                    displayIndentGuides: false,
                    printMargin: false
                });

                return editor;
            }

            const btn = document.querySelector('#code-editor-848-run-button');
            const textEditor = createEditor('code-editor-848-text', 'aql');
            const resultEditor = createEditor('code-editor-848-result', 'json');
            resultEditor.setReadOnly(true);

            function setContent(editor, content) {
                editor.setValue(content, -1);
            }

            let isRunning = false;

            function onStart() {
                isRunning = true;
                textEditor.setReadOnly(true);
                btn.classList.add('is-loading');
            }

            function onEnd(result) {
                isRunning = false;
                textEditor.setReadOnly(false);
                btn.classList.remove('is-loading');

                setContent(resultEditor, result);
            }

            btn.addEventListener('click', () => {
                if (isRunning) {
                    return;
                }

                const body = {
                        text: textEditor.getValue(),
                        params: JSON.parse("{}")
                };

                onStart();
                fetch("https:\/\/worker-pucbyp2omq-ue.a.run.app", {
                    method: 'post',
                    cache: 'no-cache',
                    headers: {
                        'Content-Type': 'application/json,encoding=utf-8'
                    },
                    body: JSON.stringify(body)
                })
                    .then(r => {
                        if (r.status === 200) {
                            return r.json()
                        }
                        
                        if (r.status === 426) {
                            throw new Error(`Too many requests. Try again later.`);
                        }
                        
                        if (r.status === 400) {
                            return r.json().then((data) => {
                                throw new Error(data.error);
                            });
                        }
                        
                        throw new Error(`Unexpected error. Try again later.`);
                    })
                    .then((data) => {
                        onEnd(JSON.stringify(data, null, 4));
                    })
                    .catch((err) => {
                        onEnd(err.message);
                    });
            });
        }, false);
    </script>
</div>
<p>The <code>WITH COUNT</code> clause can also be used to efficiently count the number of items in each group:</p>








<div class="code-editor">

    
    <button id="code-editor-118-run-button" class="run button is-pulled-right is-outlined is-light is-radiusless code-editor-button">Run</button>

    <div class="columns">
        <div class="column is-12">
            <div id="code-editor-118-text" class="code-editor-text" style="height: 220px;">
                
LET users = [{"id":1,"name":"Thorn De Banke","city":"New York City","country":"USA","status":"active","age":30},{"id":2,"name":"Adolph MacAindreis","city":"Moscow","country":"Russia","status":"active","age":25},{"id":3,"name":"Flory Maxworthy","city":"London","country":"UK","status":"active","age":40},{"id":4,"name":"Merola Blundell","city":"New York City","country":"USA","status":"inactive","age":25},{"id":5,"name":"Benson Manoelli","city":"Moscow","country":"Russia","status":"inactive","age":30},{"id":6,"name":"Cordy McVie","city":"London","country":"UK","status":"active","age":25},{"id":7,"name":"Reggy Tuck","city":"New York City","country":"USA","status":"active","age":18},{"id":8,"name":"Courtney Toogood","city":"Berlin","country":"Germany","status":"active","age":30},{"id":9,"name":"Berkley Fields","city":"Berlin","country":"Germany","status":"inactive","age":30},{"id":10,"name":"Findley Gauvain","city":"Stockholm","country":"Sweden","status":"inactive","age":30}]

FOR u IN users
  COLLECT age = u.age WITH COUNT INTO length
  
  RETURN { 
    "age" : age, 
    "count" : length 
  }

            </div>
        </div>
    </div>
    <div class="columns">
        <div class="column is-12">
            <div id="code-editor-118-result" class="code-editor-result" style="height: 220px;"></div>
        </div>
    </div>
    

    <script>
        document.addEventListener('DOMContentLoaded', function () {
            function createEditor(id, mode) {
                const editor = ace.edit(id);
                editor.setTheme("ace\/theme\/tomorrow_night");
                editor.session.setMode("ace/mode/" + mode);
                editor.setOptions({
                    displayIndentGuides: false,
                    printMargin: false
                });

                return editor;
            }

            const btn = document.querySelector('#code-editor-118-run-button');
            const textEditor = createEditor('code-editor-118-text', 'aql');
            const resultEditor = createEditor('code-editor-118-result', 'json');
            resultEditor.setReadOnly(true);

            function setContent(editor, content) {
                editor.setValue(content, -1);
            }

            let isRunning = false;

            function onStart() {
                isRunning = true;
                textEditor.setReadOnly(true);
                btn.classList.add('is-loading');
            }

            function onEnd(result) {
                isRunning = false;
                textEditor.setReadOnly(false);
                btn.classList.remove('is-loading');

                setContent(resultEditor, result);
            }

            btn.addEventListener('click', () => {
                if (isRunning) {
                    return;
                }

                const body = {
                        text: textEditor.getValue(),
                        params: JSON.parse("{}")
                };

                onStart();
                fetch("https:\/\/worker-pucbyp2omq-ue.a.run.app", {
                    method: 'post',
                    cache: 'no-cache',
                    headers: {
                        'Content-Type': 'application/json,encoding=utf-8'
                    },
                    body: JSON.stringify(body)
                })
                    .then(r => {
                        if (r.status === 200) {
                            return r.json()
                        }
                        
                        if (r.status === 426) {
                            throw new Error(`Too many requests. Try again later.`);
                        }
                        
                        if (r.status === 400) {
                            return r.json().then((data) => {
                                throw new Error(data.error);
                            });
                        }
                        
                        throw new Error(`Unexpected error. Try again later.`);
                    })
                    .then((data) => {
                        onEnd(JSON.stringify(data, null, 4));
                    })
                    .catch((err) => {
                        onEnd(err.message);
                    });
            });
        }, false);
    </script>
</div>
<div class="notification is-info">
    The WITH COUNT clause can only be used together with an INTO clause.
</div>



<h3 id="collect-aggregation">
<a href="#collect-aggregation">
Aggregation
</a>
</h3>
<p>A <code>COLLECT</code> statement can be used to perform aggregation of data per group. To only determine group lengths, the <code>WITH COUNT INTO</code> variant of <code>COLLECT</code> can be used as described before.</p>
<p>For other aggregations, it is possible to run aggregate functions on the <code>COLLECT</code> results:</p>








<div class="code-editor">

    
    <button id="code-editor-764-run-button" class="run button is-pulled-right is-outlined is-light is-radiusless code-editor-button">Run</button>

    <div class="columns">
        <div class="column is-12">
            <div id="code-editor-764-text" class="code-editor-text" style="height: 310px;">
                
LET users = [{"id":1,"name":"Thorn De Banke","city":"New York City","country":"USA","status":"active","age":30},{"id":2,"name":"Adolph MacAindreis","city":"Moscow","country":"Russia","status":"active","age":25},{"id":3,"name":"Flory Maxworthy","city":"London","country":"UK","status":"active","age":40},{"id":4,"name":"Merola Blundell","city":"New York City","country":"USA","status":"inactive","age":25},{"id":5,"name":"Benson Manoelli","city":"Moscow","country":"Russia","status":"inactive","age":30},{"id":6,"name":"Cordy McVie","city":"London","country":"UK","status":"active","age":25},{"id":7,"name":"Reggy Tuck","city":"New York City","country":"USA","status":"active","age":18},{"id":8,"name":"Courtney Toogood","city":"Berlin","country":"Germany","status":"active","age":30},{"id":9,"name":"Berkley Fields","city":"Berlin","country":"Germany","status":"inactive","age":30},{"id":10,"name":"Findley Gauvain","city":"Stockholm","country":"Sweden","status":"inactive","age":30}]

FOR u IN users
  COLLECT ageGroup = FLOOR(u.age / 5) * 5 INTO g

  LET ages = (
      FOR i IN g
        RETURN i.u.age
  )
  
  RETURN { 
    "ageGroup" : ageGroup,
    "minAge" : MIN(ages),
    "maxAge" : MAX(ages)
  }

            </div>
        </div>
    </div>
    <div class="columns">
        <div class="column is-12">
            <div id="code-editor-764-result" class="code-editor-result" style="height: 310px;"></div>
        </div>
    </div>
    

    <script>
        document.addEventListener('DOMContentLoaded', function () {
            function createEditor(id, mode) {
                const editor = ace.edit(id);
                editor.setTheme("ace\/theme\/tomorrow_night");
                editor.session.setMode("ace/mode/" + mode);
                editor.setOptions({
                    displayIndentGuides: false,
                    printMargin: false
                });

                return editor;
            }

            const btn = document.querySelector('#code-editor-764-run-button');
            const textEditor = createEditor('code-editor-764-text', 'aql');
            const resultEditor = createEditor('code-editor-764-result', 'json');
            resultEditor.setReadOnly(true);

            function setContent(editor, content) {
                editor.setValue(content, -1);
            }

            let isRunning = false;

            function onStart() {
                isRunning = true;
                textEditor.setReadOnly(true);
                btn.classList.add('is-loading');
            }

            function onEnd(result) {
                isRunning = false;
                textEditor.setReadOnly(false);
                btn.classList.remove('is-loading');

                setContent(resultEditor, result);
            }

            btn.addEventListener('click', () => {
                if (isRunning) {
                    return;
                }

                const body = {
                        text: textEditor.getValue(),
                        params: JSON.parse("{}")
                };

                onStart();
                fetch("https:\/\/worker-pucbyp2omq-ue.a.run.app", {
                    method: 'post',
                    cache: 'no-cache',
                    headers: {
                        'Content-Type': 'application/json,encoding=utf-8'
                    },
                    body: JSON.stringify(body)
                })
                    .then(r => {
                        if (r.status === 200) {
                            return r.json()
                        }
                        
                        if (r.status === 426) {
                            throw new Error(`Too many requests. Try again later.`);
                        }
                        
                        if (r.status === 400) {
                            return r.json().then((data) => {
                                throw new Error(data.error);
                            });
                        }
                        
                        throw new Error(`Unexpected error. Try again later.`);
                    })
                    .then((data) => {
                        onEnd(JSON.stringify(data, null, 4));
                    })
                    .catch((err) => {
                        onEnd(err.message);
                    });
            });
        }, false);
    </script>
</div>
<p>The above however requires storing all group values during the collect operation for all groups, which can be inefficient.</p>
<p>The special <code>AGGREGATE</code> variant of <code>COLLECT</code> allows building the aggregate values incrementally during the collect operation, and is therefore often more efficient.</p>
<p>With the <code>AGGREGATE</code> variant the above query becomes:</p>








<div class="code-editor">

    
    <button id="code-editor-772-run-button" class="run button is-pulled-right is-outlined is-light is-radiusless code-editor-button">Run</button>

    <div class="columns">
        <div class="column is-12">
            <div id="code-editor-772-text" class="code-editor-text" style="height: 250px;">
                
LET users = [{"id":1,"name":"Thorn De Banke","city":"New York City","country":"USA","status":"active","age":30},{"id":2,"name":"Adolph MacAindreis","city":"Moscow","country":"Russia","status":"active","age":25},{"id":3,"name":"Flory Maxworthy","city":"London","country":"UK","status":"active","age":40},{"id":4,"name":"Merola Blundell","city":"New York City","country":"USA","status":"inactive","age":25},{"id":5,"name":"Benson Manoelli","city":"Moscow","country":"Russia","status":"inactive","age":30},{"id":6,"name":"Cordy McVie","city":"London","country":"UK","status":"active","age":25},{"id":7,"name":"Reggy Tuck","city":"New York City","country":"USA","status":"active","age":18},{"id":8,"name":"Courtney Toogood","city":"Berlin","country":"Germany","status":"active","age":30},{"id":9,"name":"Berkley Fields","city":"Berlin","country":"Germany","status":"inactive","age":30},{"id":10,"name":"Findley Gauvain","city":"Stockholm","country":"Sweden","status":"inactive","age":30}]

FOR u IN users
  COLLECT ageGroup = FLOOR(u.age / 5) * 5 
  AGGREGATE minAge = MIN(u.age), maxAge = MAX(u.age)
  
  RETURN {
    ageGroup, 
    minAge, 
    maxAge 
  }

            </div>
        </div>
    </div>
    <div class="columns">
        <div class="column is-12">
            <div id="code-editor-772-result" class="code-editor-result" style="height: 250px;"></div>
        </div>
    </div>
    

    <script>
        document.addEventListener('DOMContentLoaded', function () {
            function createEditor(id, mode) {
                const editor = ace.edit(id);
                editor.setTheme("ace\/theme\/tomorrow_night");
                editor.session.setMode("ace/mode/" + mode);
                editor.setOptions({
                    displayIndentGuides: false,
                    printMargin: false
                });

                return editor;
            }

            const btn = document.querySelector('#code-editor-772-run-button');
            const textEditor = createEditor('code-editor-772-text', 'aql');
            const resultEditor = createEditor('code-editor-772-result', 'json');
            resultEditor.setReadOnly(true);

            function setContent(editor, content) {
                editor.setValue(content, -1);
            }

            let isRunning = false;

            function onStart() {
                isRunning = true;
                textEditor.setReadOnly(true);
                btn.classList.add('is-loading');
            }

            function onEnd(result) {
                isRunning = false;
                textEditor.setReadOnly(false);
                btn.classList.remove('is-loading');

                setContent(resultEditor, result);
            }

            btn.addEventListener('click', () => {
                if (isRunning) {
                    return;
                }

                const body = {
                        text: textEditor.getValue(),
                        params: JSON.parse("{}")
                };

                onStart();
                fetch("https:\/\/worker-pucbyp2omq-ue.a.run.app", {
                    method: 'post',
                    cache: 'no-cache',
                    headers: {
                        'Content-Type': 'application/json,encoding=utf-8'
                    },
                    body: JSON.stringify(body)
                })
                    .then(r => {
                        if (r.status === 200) {
                            return r.json()
                        }
                        
                        if (r.status === 426) {
                            throw new Error(`Too many requests. Try again later.`);
                        }
                        
                        if (r.status === 400) {
                            return r.json().then((data) => {
                                throw new Error(data.error);
                            });
                        }
                        
                        throw new Error(`Unexpected error. Try again later.`);
                    })
                    .then((data) => {
                        onEnd(JSON.stringify(data, null, 4));
                    })
                    .catch((err) => {
                        onEnd(err.message);
                    });
            });
        }, false);
    </script>
</div>
<p>The <code>AGGREGATE</code> keyword can only be used after the <code>COLLECT</code> keyword. If used, it must directly follow the declaration of the grouping keys. If no grouping keys are used, it must follow the <code>COLLECT</code> keyword directly:</p>








<div class="code-editor">

    
    <button id="code-editor-306-run-button" class="run button is-pulled-right is-outlined is-light is-radiusless code-editor-button">Run</button>

    <div class="columns">
        <div class="column is-12">
            <div id="code-editor-306-text" class="code-editor-text" style="height: 250px;">
                
LET users = [{"id":1,"name":"Thorn De Banke","city":"New York City","country":"USA","status":"active","age":30},{"id":2,"name":"Adolph MacAindreis","city":"Moscow","country":"Russia","status":"active","age":25},{"id":3,"name":"Flory Maxworthy","city":"London","country":"UK","status":"active","age":40},{"id":4,"name":"Merola Blundell","city":"New York City","country":"USA","status":"inactive","age":25},{"id":5,"name":"Benson Manoelli","city":"Moscow","country":"Russia","status":"inactive","age":30},{"id":6,"name":"Cordy McVie","city":"London","country":"UK","status":"active","age":25},{"id":7,"name":"Reggy Tuck","city":"New York City","country":"USA","status":"active","age":18},{"id":8,"name":"Courtney Toogood","city":"Berlin","country":"Germany","status":"active","age":30},{"id":9,"name":"Berkley Fields","city":"Berlin","country":"Germany","status":"inactive","age":30},{"id":10,"name":"Findley Gauvain","city":"Stockholm","country":"Sweden","status":"inactive","age":30}]

FOR u IN users
  COLLECT AGGREGATE minAge = MIN(u.age), maxAge = MAX(u.age)
  
  RETURN {
    minAge, 
    maxAge 
  }

            </div>
        </div>
    </div>
    <div class="columns">
        <div class="column is-12">
            <div id="code-editor-306-result" class="code-editor-result" style="height: 250px;"></div>
        </div>
    </div>
    

    <script>
        document.addEventListener('DOMContentLoaded', function () {
            function createEditor(id, mode) {
                const editor = ace.edit(id);
                editor.setTheme("ace\/theme\/tomorrow_night");
                editor.session.setMode("ace/mode/" + mode);
                editor.setOptions({
                    displayIndentGuides: false,
                    printMargin: false
                });

                return editor;
            }

            const btn = document.querySelector('#code-editor-306-run-button');
            const textEditor = createEditor('code-editor-306-text', 'aql');
            const resultEditor = createEditor('code-editor-306-result', 'json');
            resultEditor.setReadOnly(true);

            function setContent(editor, content) {
                editor.setValue(content, -1);
            }

            let isRunning = false;

            function onStart() {
                isRunning = true;
                textEditor.setReadOnly(true);
                btn.classList.add('is-loading');
            }

            function onEnd(result) {
                isRunning = false;
                textEditor.setReadOnly(false);
                btn.classList.remove('is-loading');

                setContent(resultEditor, result);
            }

            btn.addEventListener('click', () => {
                if (isRunning) {
                    return;
                }

                const body = {
                        text: textEditor.getValue(),
                        params: JSON.parse("{}")
                };

                onStart();
                fetch("https:\/\/worker-pucbyp2omq-ue.a.run.app", {
                    method: 'post',
                    cache: 'no-cache',
                    headers: {
                        'Content-Type': 'application/json,encoding=utf-8'
                    },
                    body: JSON.stringify(body)
                })
                    .then(r => {
                        if (r.status === 200) {
                            return r.json()
                        }
                        
                        if (r.status === 426) {
                            throw new Error(`Too many requests. Try again later.`);
                        }
                        
                        if (r.status === 400) {
                            return r.json().then((data) => {
                                throw new Error(data.error);
                            });
                        }
                        
                        throw new Error(`Unexpected error. Try again later.`);
                    })
                    .then((data) => {
                        onEnd(JSON.stringify(data, null, 4));
                    })
                    .catch((err) => {
                        onEnd(err.message);
                    });
            });
        }, false);
    </script>
</div>
<p>Only specific expressions are allowed on the right-hand side of each AGGREGATE assignment:</p>
<ul>
<li>an aggregate expression must not refer to variables introduced by the COLLECT itself</li>
</ul>

</article>
        </section>
        
        

    </div>
</div>

        </div><footer class="footer">
    <div class="columns">
        <div class="column is-4 is-hidden-mobile">
            <p>
                <a href="https://github.com/MontFerret">
                    © 2018-2023 MontFerret Team
                </a>
            </p>
            <p>
                <a href="https://www.montferret.dev/blog/index.xml">RSS</a>
            </p>
        </div>
        <div class="column is-4 has-text-centered">
            <img src="/img/logo.png" width="30" height="30" />
        </div>
        <div class="column is-4 has-text-right is-hidden-mobile">
            <a href="#">BACK TO TOP Δ</a>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/ace/1.4.11/ace.min.js"
        integrity="sha256-qCCcAHv/Z0u7K344shsZKUF2NR+59ooA3XWRj0LPGIQ=" crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/ace/1.4.11/mode-aql.min.js"
        integrity="sha256-X0EL61aEe9ZmA9OkWgfPw7QMJc2DPs3/RcarIt15j8Y=" crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/ace/1.4.11/mode-json.min.js"
        integrity="sha256-oMH6MIx8AGl0OseaL8vGcdSb9ons1Jprkf4xXAyzvNc=" crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/ace/1.4.11/mode-golang.min.js"
        integrity="sha256-0SvSdpO3x7J6KQZ5Y9ghI0wph0l0DDMUaOQu+Swjup0=" crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/ace/1.4.11/theme-tomorrow_night.min.js"
        integrity="sha256-NbswWaBBhaLvBJ18ocfQ7sC/Iy/+7KvGq0YRjvLRpk4=" crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/ace/1.4.11/mode-sh.min.js"
        integrity="sha256-uzCsgXA65+SIa2CRZSX6+Ls6DKZkddI5rtRXr1uOE2Y=" crossorigin="anonymous"></script>
</footer></body>
</html>
